!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs/observable/fromPromise"),require("rxjs/observable/from"),require("rxjs/observable/of"),require("rxjs/BehaviorSubject"),require("angularfire2/storage"),require("rxjs/operators/debounceTime"),require("rxjs/operators/combineAll"),require("rxjs/operators/concatMap"),require("rxjs/operators/switchMap"),require("rxjs/operators/takeUntil"),require("rxjs/operators/finalize"),require("rxjs/operators/map"),require("rxjs/operators/tap"),require("rxjs/observable/forkJoin"),require("rxjs/Subject"),require("@angular/common")):"function"==typeof define&&define.amd?define("@ngx-fire-uploader/core",["exports","@angular/core","rxjs/observable/fromPromise","rxjs/observable/from","rxjs/observable/of","rxjs/BehaviorSubject","angularfire2/storage","rxjs/operators/debounceTime","rxjs/operators/combineAll","rxjs/operators/concatMap","rxjs/operators/switchMap","rxjs/operators/takeUntil","rxjs/operators/finalize","rxjs/operators/map","rxjs/operators/tap","rxjs/observable/forkJoin","rxjs/Subject","@angular/common"],t):t((e["ngx-fire-uploader"]=e["ngx-fire-uploader"]||{},e["ngx-fire-uploader"].core={}),e.ng.core,e.Rx.Observable,e.Rx.Observable,e.Rx.Observable,e.Rx,e.storage,e.Rx.Observable.prototype,e.Rx.Observable.prototype,e.Rx.Observable.prototype,e.Rx.Observable.prototype,e.Rx.Observable.prototype,e.Rx.Observable.prototype,e.Rx.Observable.prototype,e.Rx.Observable.prototype,e.Rx.Observable,e.Rx,e.ng.common)}(this,function(e,r,t,n,o,s,i,a,p,u,l,c,h,m,f,d,g,y){"use strict";function v(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var s,i,n=r.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(s=n.next()).done;)a.push(s.value)}catch(o){i={error:o}}finally{try{s&&!s.done&&(r=n["return"])&&r.call(n)}finally{if(i)throw i.error}}return a}function b(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(v(arguments[t]));return e}var x=new r.InjectionToken("config"),_={dropZone:!0,paramName:null,uniqueName:!0,placeholder:"Drop files here or click to select",multiple:!0,accept:null,parallelUploads:1,maxFiles:20,autoStart:!1,thumbs:!0,thumbMethod:"contain",thumbWidth:100,thumbHeight:100,resizeMethod:"crop",resizeWidth:null,resizeHeight:null,resizeMimeType:null,resizeQuality:1},E=function(e){this.config=Object.assign({},_,e)};function S(o,p,u,l,c){return u?p||(p=u):u=p,t.fromPromise(new Promise(function(n,e){var a=new Image;a.src=URL.createObjectURL(o),a.onload=function(){var e,t,r=a.width,s=a.height;switch(r<=p&&s<=u&&n(o),l){case"contain":s<r?e=r*((t=u)/s):t=s*((e=p)/r);break;case"crop":s<r?(t=s*(p/r),e=p):(e=r*(u/s),t=u)}var i=document.createElement("canvas");i.width=e,i.height=t,i.getContext("2d").drawImage(a,0,0,e,t),"function"==typeof i.toBlob?i.toBlob(n,o.type,c):n(i.msToBlob())},a.onerror=e}))}E.decorators=[{type:r.Injectable}],E.ctorParameters=function(){return[{type:undefined,decorators:[{type:r.Optional},{type:r.Inject,args:[x]}]}]};var j=function(e){return"image"===e.type.split("/")[0]},O=function(){function e(e,t){var r=this;this.file=e,this._uploader=t,this.snapshot$=new s.BehaviorSubject({}),this.updateSnapshot({name:e.name,type:e.type,active:!1,extension:e.name.split(".").pop(),progress:{percentage:0,bytesTransferred:0,totalBytes:e.size}}),this._uploader.thumbs&&j(e)&&S(e,this._uploader.thumbWidth,this._uploader.thumbHeight,this._uploader.thumbnailMethod,1).subscribe(function(e){return r.updateSnapshot({thumbnail:URL.createObjectURL(e)})},function(e){return r._uploader.errorEmitter.emit(e)})}return e.prototype.assignTask=function(e){var t=this;return this._task=e,this._task.snapshotChanges().subscribe(function(e){return t.onSnapshotChanges(e)}),this._task.then(function(e){return t.onTaskComplete(e)})["catch"](function(e){t.updateSnapshot({active:!1}),t._uploader.errorEmitter.emit(e)})},e.prototype["delete"]=function(){var t=this;this.snapshot.ref["delete"]().then(function(){t._uploader.removeEmitter.emit(t),t.cancel()})["catch"](function(e){return t._uploader.errorEmitter.emit(e)})},e.prototype.pause=function(){this._task&&this._task.pause()},e.prototype.resume=function(){this._task&&this._task.resume()},e.prototype.cancel=function(){this._task&&this._task.cancel(),this.reset()},e.prototype.reset=function(){this.updateSnapshot({state:null,active:!1,downloadURL:null,progress:{percentage:0,bytesTransferred:0,totalBytes:this.file.size}})},e.prototype.updateSnapshot=function(e){this.snapshot=Object.assign({},this.snapshot,e),this.snapshot$.next(this.snapshot)},e.prototype.onSnapshotChanges=function(e){this.updateSnapshot({active:"running"===e.state,state:e.state,progress:{percentage:e.bytesTransferred/e.totalBytes*100,bytesTransferred:e.bytesTransferred,totalBytes:e.totalBytes}}),this._uploader.updateRootState$.next(null)},e.prototype.onTaskComplete=function(e){e.downloadURL&&(this.updateSnapshot({downloadURL:e.downloadURL,ref:e.ref,active:!1,state:e.state,progress:{percentage:e.bytesTransferred/e.totalBytes*100,bytesTransferred:e.bytesTransferred,totalBytes:e.totalBytes}}),this._uploader.successEmitter.emit(this))},e}(),z=function(){function e(e,t){this._manager=e,this._storage=t,this._initialState={files:[],active:!1,progress:{totalBytes:0,bytesTransferred:0,percentage:0}},this._state=this._initialState,this.state$=new s.BehaviorSubject(this._initialState),this.updateRootState$=new s.BehaviorSubject({}),this._cancelUpload$=new g.Subject,this.dropZone=this._manager.config.dropZone,this.paramName=this._manager.config.paramName,this.uniqueName=this._manager.config.uniqueName,this.placeholder=this._manager.config.placeholder,this.multiple=this._manager.config.multiple,this.accept=this._manager.config.accept,this.parallelUploads=this._manager.config.parallelUploads,this.maxFiles=this._manager.config.maxFiles,this.maxFileSize=this._manager.config.maxFileSize,this.autoStart=this._manager.config.autoStart,this.thumbs=this._manager.config.thumbs,this.thumbnailMethod=this._manager.config.thumbMethod,this.resizeMethod=this._manager.config.resizeMethod,this.resizeWidth=this._manager.config.resizeWidth,this.resizeHeight=this._manager.config.resizeHeight,this.resizeQuality=this._manager.config.resizeQuality,this.thumbWidth=this._manager.config.thumbWidth,this.thumbHeight=this._manager.config.thumbHeight,this.resizeMimeType=this._manager.config.resizeMimeType,this.filesEmitter=new r.EventEmitter,this.removeEmitter=new r.EventEmitter,this.successEmitter=new r.EventEmitter,this.completeEmitter=new r.EventEmitter,this.valueEmitter=new r.EventEmitter,this.errorEmitter=new r.EventEmitter,this.activeEmitter=new r.EventEmitter,this.progressEmitter=new r.EventEmitter,this.resetEmitter=new r.EventEmitter}return e.prototype.ngOnInit=function(){var t=this;this.updateRootState$.pipe(a.debounceTime(50),m.map(function(){if(t._state.files.length){var e=t.combineStates();return{active:e.active,progress:{percentage:e.progress.bytesTransferred/e.progress.totalBytes*100,bytesTransferred:e.progress.bytesTransferred,totalBytes:e.progress.totalBytes}}}return{active:!1,progress:{percentage:0,bytesTransferred:0,totalBytes:0}}}),f.tap(function(e){t.setState(e),t.progressEmitter.emit(e.progress),t.activeEmitter.emit(e.active)})).subscribe()},e.prototype.ngOnDestroy=function(){this.progressEmitter.observers.length&&this.updateRootState$.complete()},e.prototype.start=function(){var a=this;!this._state.active&&this._state.files.length&&n.from(this._state.files).pipe(m.map(function(e){return t=e,r=a.resizeWidth,s=a.resizeHeight,i=a.resizeMethod,n=a.resizeQuality,r||s?S(t.file,r,s,i,n):o.of(t);var t,r,s,i,n}),p.combineAll(),l.switchMap(function(e){return function(e,t){var r,s,i=[];for(r=0,s=e.length;r<s;r+=t)i.push(e.slice(r,r+t));return n.from(i)}(e,a.parallelUploads)}),u.concatMap(function(e){return a.uploadFiles(e)}),c.takeUntil(this._cancelUpload$),h.finalize(function(){var e=a._state.files.filter(function(e){return"success"===e.snapshot});a.completeEmitter.emit(e);var t=e.map(function(e){return e.snapshot.downloadURL});a.valueEmitter.emit(t),a.updateRootState$.next(null)})).subscribe()},e.prototype.select=function(){this.fileInput.nativeElement.click()},e.prototype.addFiles=function(e){var t=this;this.validateFiles(e).then(function(e){t.setState({files:e}),t.filesEmitter.emit(e),t.updateRootState$.next(null),t.autoStart&&t.start()})},e.prototype.removeFile=function(t){"success"===t.snapshot.state?t["delete"]():"running"===t.snapshot.state?t.cancel():this.removeEmitter.emit(t),t.snapshot$.complete();var e=this._state.files.filter(function(e){return e!==t});this.setState({files:e}),this.filesEmitter.emit(this._state.files),this.updateRootState$.next(null)},e.prototype.reset=function(e){void 0===e&&(e=!0),this.cancel(e),this.setState({files:[]}),this.filesEmitter.emit([]),this.updateRootState$.next(null),this.resetEmitter.emit()},e.prototype.cancelFile=function(e){e.cancel(),this.updateRootState$.next(null)},e.prototype.cancel=function(t){void 0===t&&(t=!0),this._cancelUpload$.next(),this._state.files.map(function(e){t&&"success"===e.snapshot.state?e["delete"]():e.cancel()})},e.prototype.pause=function(){this._state.files.map(function(e){return e.pause()})},e.prototype.resume=function(){this._state.files.map(function(e){return e.resume()})},e.prototype.setState=function(e){this._state=Object.assign({},this._state,e),this.state$.next(this._state)},e.prototype.validateFiles=function(n){var a=this;return new Promise(function(e,t){var r=[];if(n.length){var s=void 0;n.length>a.maxFiles?(a.errorEmitter.emit({type:"uploader/count_limit_exceeded",message:"Max files has exceeded, Only "+a.maxFiles+" is accepted."}),s=a.maxFiles):s=n.length;for(var i=0;i<s;i++){if(n[i].size/1024/1024>a.maxFileSize)a.errorEmitter.emit({type:"uploader/size_limit_exceeded",message:n[i].name+" has exceeded the max size allowed."});else r=b(r,[new O(n[i],a)])}a.multiple&&(r=b(a._state.files,r).filter(function(t,e,r){return r.findIndex(function(e){return e.file.name===t.file.name&&e.file.size===t.file.size})===e})),e(r)}e(a._state.files)})},e.prototype.uploadFiles=function(e){var s=this,t=e.map(function(e){var t=(new Date).getTime()+"_"+(s.paramName||e.snapshot.name),r=s._storage.upload(t,e.file);return e.assignTask(r)});return d.forkJoin.apply(void 0,b(t))},e.prototype.combineStates=function(){return this._state.files.map(function(e){return e.snapshot}).reduce(function(e,t){return{active:e.active||t.active,progress:{bytesTransferred:e.progress.bytesTransferred+t.progress.bytesTransferred,totalBytes:e.progress.totalBytes+t.progress.totalBytes}}})},e}();z.decorators=[{type:r.Component,args:[{selector:"fire-uploader",changeDetection:r.ChangeDetectionStrategy.OnPush,template:'<ng-container *ngIf="state$ | async; let state">\n  <input #fileInput type="file"\n         [accept]="accept"\n         [multiple]="multiple"\n         (click)="fileInput.value=null"\n         (change)="addFiles(fileInput.files)">\n  <div *ngIf="dropZone"\n       class="dropzone"\n       (dropZone)="addFiles($event)"\n       (click)="fileInput.click()"\n       (dragOver)="hoverClass=$event">\n    <div class="dropzone-placeholder"\n         *ngIf="!state.files.length || !content.children.length">\n      {{ placeholder }}\n    </div>\n    <div class="overlay-layer"></div>\n    <div class="uploader-content" #content>\n      <ng-content></ng-content>\n    </div>\n  </div>\n</ng-container>\n'}]}],z.ctorParameters=function(){return[{type:E},{type:i.AngularFireStorage}]},z.propDecorators={dropZone:[{type:r.Input}],paramName:[{type:r.Input}],uniqueName:[{type:r.Input}],placeholder:[{type:r.Input}],multiple:[{type:r.Input}],accept:[{type:r.Input}],parallelUploads:[{type:r.Input}],maxFiles:[{type:r.Input}],maxFileSize:[{type:r.Input}],autoStart:[{type:r.Input}],thumbs:[{type:r.Input}],thumbnailMethod:[{type:r.Input}],resizeMethod:[{type:r.Input}],resizeWidth:[{type:r.Input}],resizeHeight:[{type:r.Input}],resizeQuality:[{type:r.Input}],thumbWidth:[{type:r.Input}],thumbHeight:[{type:r.Input}],resizeMimeType:[{type:r.Input}],filesEmitter:[{type:r.Output,args:["files"]}],removeEmitter:[{type:r.Output,args:["remove"]}],successEmitter:[{type:r.Output,args:["success"]}],completeEmitter:[{type:r.Output,args:["complete"]}],valueEmitter:[{type:r.Output,args:["value"]}],errorEmitter:[{type:r.Output,args:["error"]}],activeEmitter:[{type:r.Output,args:["active"]}],progressEmitter:[{type:r.Output,args:["progress"]}],resetEmitter:[{type:r.Output,args:["reset"]}],fileInput:[{type:r.ViewChild,args:["fileInput"]}],hoverClass:[{type:r.HostBinding,args:["class.dragover"]}]};var w=function(){function e(){this.dropZone=new r.EventEmitter,this.dragOver=new r.EventEmitter}return e.prototype.onDrop=function(e){e.preventDefault(),this.dragOver.emit(!1),this.dropZone.emit(e.dataTransfer.files)},e.prototype.onDragOver=function(e){e.preventDefault(),this.dragOver.emit(!0)},e.prototype.onDragLeave=function(e){e.preventDefault(),this.dragOver.emit(!1)},e}();function I(e){return new E(e)}w.decorators=[{type:r.Directive,args:[{selector:"[dropZone]"}]}],w.ctorParameters=function(){return[]},w.propDecorators={dropZone:[{type:r.Output,args:["dropZone"]}],dragOver:[{type:r.Output}],onDrop:[{type:r.HostListener,args:["drop",["$event"]]}],onDragOver:[{type:r.HostListener,args:["dragover",["$event"]]}],onDragLeave:[{type:r.HostListener,args:["dragleave",["$event"]]}]};var R=function(){function t(){}return t.forRoot=function(e){return{ngModule:t,providers:[{provide:x,useValue:e},{provide:E,useFactory:I,deps:[x]}]}},t}();R.decorators=[{type:r.NgModule,args:[{imports:[y.CommonModule],exports:[z],declarations:[z,w]}]}],R.ctorParameters=function(){return[]},e.UploaderFactory=I,e.FireUploaderModule=R,e.FireUploaderComponent=z,e.FileItem=O,e.ɵc=w,e.ɵa=E,e.ɵb=x,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=ngx-fire-uploader-core.umd.min.js.map
